function setMinDateTime(e=!1){let t=new Date;t.setMinutes(t.getMinutes()+15),t.setSeconds(0,0);let a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,n=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`;const i=document.getElementById("book_pick_date"),s=document.getElementById("book_pick_time"),o=document.getElementById("timeError");if(window.errorTimeout||(window.errorTimeout=null),i.min=a,i.value===a)if(s.min=n,s.value&&s.value<n){if(s.value=n,e){let e=s.value;o.textContent=`You can select a time from ${e} onwards, but not earlier.`,o.style.display="block",s.classList.add("field-error"),clearTimeout(window.errorTimeout),window.errorTimeout=setTimeout(()=>{o.style.display="none",s.classList.remove("field-error")},3e3)}}else o.style.display="none",s.classList.remove("field-error");else s.min="00:00",o.style.display="none",s.classList.remove("field-error");i.dataset.userChanged||(i.value=a),s.dataset.userChanged||(s.value=n)}setMinDateTime(),setInterval(()=>setMinDateTime(),3e4),document.getElementById("book_pick_date").addEventListener("input",e=>{e.target.dataset.userChanged=!0,setMinDateTime(!0)}),document.getElementById("book_pick_time").addEventListener("input",e=>{e.target.dataset.userChanged=!0,setMinDateTime(!0)});const hardcodedAddresses=["LONDON HEATHROW AIRPORT TERMINAL 2 | TW6 1EW","LONDON HEATHROW AIRPORT TERMINAL 3 | TW6 1QG","LONDON HEATHROW AIRPORT TERMINAL 4 | TW6 3XA","LONDON HEATHROW AIRPORT TERMINAL 5 | TW6 2GA","LONDON GATWICK AIRPORT NORTH TERMINAL | RH6 0PJ","LONDON GATWICK AIRPORT SOUTH TERMINAL  | RH6 0NP","LONDON CITY AIRPORT | E16 2PX","LONDON STANSTED AIRPORT | CM24 1RW","LONDON LUTON AIRPORT | LU2 9QT"],NON_SELECTABLE_VALUES=["__info__","__searching__","__invalid__"];let viaCount=0;const maxViaFields=7;function clearFieldError(e){e.removeClass("field-error"),e.closest(".field").find(".error-msg").remove()}function applyAutocomplete(e){e.autocomplete({open:function(e,t){let a=e.target.getBoundingClientRect();$(".ui-autocomplete").css({top:a.bottom+window.scrollY+"px",left:a.left+window.scrollX+"px",width:a.width+"px"})},minLength:0,delay:300,source:function(e,t){const a=e.term.trim(),n=3-a.length;if(a.length<3){const e=[{label:`Please enter ${n} more character${1===n?"":"s"} to start searching`,value:"__info__"}].concat(hardcodedAddresses.map(e=>({label:e,value:e})));t(e)}else t([{label:"Searching...",value:"__searching__"}]),$.ajax({url:`https://${destnationDomain}/Home/Indextwo`,dataType:"json",data:{Prefix:a},success:function(e){if(Array.isArray(e.list)&&e.list.length){const a=new Set,n=e.list.map(e=>e.address.trim()).filter(e=>{const t=e.toLowerCase();return!a.has(t)&&(a.add(t),!0)}).map(e=>({label:e,value:e}));t(n)}else t([{label:`That's odd. We couldn't find any results for "<span>${a}</span>"`,value:"__invalid__"}])},error:function(){t([{label:"Error contacting server",value:"__invalid__"}])}})},focus:function(e,t){if(NON_SELECTABLE_VALUES.includes(t.item.value))return e.preventDefault(),!1},select:function(t,a){if(NON_SELECTABLE_VALUES.includes(a.item.value))return t.preventDefault(),!1;e.val(a.item.value),e.data("selected",!0),e.data("valid",!0),e.data("original",a.item.value),clearFieldError(e),setTimeout(()=>{e.blur()},0)},change:function(t,a){a.item&&!NON_SELECTABLE_VALUES.includes(a.item.value)||e.data("valid",!1)}}),e.autocomplete("instance")._renderItem=function(e,t){const a=$("<li>"),n=$("<div>").addClass("ui-menu-item-wrapper");return"__searching__"===t.value?(n.html(`<span class="inputListLoaderInner"></span>${t.label}`),a.addClass("ui-state-disabled"),n.addClass("addrSearching")):"__info__"===t.value?(n.html(`${t.label}`),a.addClass("ui-state-disabled"),n.addClass("info-message")):"__invalid__"===t.value?(n.html(`${t.label}`),a.addClass("ui-state-disabled"),n.addClass("invalidInput")):hardcodedAddresses.includes(t.label)?(n.html(`${t.label}`),n.addClass("airportList")):NON_SELECTABLE_VALUES.includes(t.value)?(n.html(t.label),a.addClass("ui-state-disabled")):n.html(t.label),a.append(n).appendTo(e)},e.on("focus",function(){$(this).autocomplete("search",$(this).val()),e.data("focused",!0)}),e.on("blur",function(){const e=$(this),t=e.val().trim(),a=e.data("valid"),n=e.data("original");setTimeout(()=>{if(""===t)return e.val(""),void e.data("valid",!1);const i=e.autocomplete("widget").find("li").filter(function(){const e=$(this).data("uiAutocompleteItem");return e&&!NON_SELECTABLE_VALUES.includes(e.value)});if(!a&&i.length>0){const t=i.first().data("uiAutocompleteItem");hardcodedAddresses.includes(t.value)?n?(e.val(n),e.data("valid",!0),clearFieldError(e)):(e.val(""),e.data("valid",!1)):(e.val(t.value),e.data("valid",!0),e.data("original",t.value),clearFieldError(e))}else a||n&&!NON_SELECTABLE_VALUES.includes(t)?n&&t!==n&&(e.val(n),e.data("valid",!0),clearFieldError(e)):(e.val(""),e.data("valid",!1))},150)}),e.on("input",function(){$(this).val().trim()===$(this).data("original")&&($(this).data("valid",!0),clearFieldError($(this)))})}function toggleAddButton(){viaCount>=7?$("#add-via").hide():$("#add-via").show()}function validateAddressField(e){if(!e||!e.length)return!1;const t=e.val().trim(),a=e.data("valid");return e.removeClass("field-error"),e.closest(".field").find(".error-msg").remove(),t?!!a||(e.addClass("field-error"),e.closest(".field").append('<span class="error-msg">Please select a valid address from suggestions.</span>'),!1):(e.addClass("field-error"),e.closest(".field").append('<span class="error-msg">This field cannot be empty.</span>'),!1)}function TDate(){var e=new Date;new Date(document.getElementById("book_pick_date").value).toJSON().slice(0,10)<(new Date).toJSON().slice(0,10)?(alert("Do Not Select the Previous Data"),document.getElementById("book_pick_date").value=e.getDate(),$("#book_pick_date").val("")):getTime()}function iswaitnreturn(e){"WR"==$(e).val()?$("#myModalitem").modal({show:!0,keyboard:!1,backdrop:"static"}):waitingtime=0}function savewaitnreturn(){$("#myModalitem").modal("toggle"),waitingtime=$("#minwaittime").val()}$.ui.autocomplete.prototype._move=function(e,t){if(!this.menu.element.is(":visible"))return void this.search(null,t);this.menu[e](t);const a=this.menu.active;a&&NON_SELECTABLE_VALUES.includes(a.data("ui-autocomplete-item").value)&&this._move(e,t)},applyAutocomplete($("#pickup")),applyAutocomplete($("#dropof")),$("#add-via").on("click",function(){if(viaCount>=7)return;const e=$("#via-list .fieldInput").last();if(e.length&&!e.val().trim())return void e.focus();viaCount++;const t=$(`\n    <div class="field">\n      <div class="field-hd">\n        <span class="viaFieldHd">Via ${viaCount}</span>\n      </div>\n      <div class="viaFieldBtnWrap fieldScaleable">\n        <input type="text" class="fieldInput viadata" placeholder="Enter Via Location">\n        <button type="button" class="removeField">\n          <img src="https://book.barnettaxis.co.uk/images/close.png" alt="Cut Via">\n        </button>\n      </div>\n    </div>\n  `);$("#via-list").append(t),applyAutocomplete(t.find("input")),toggleAddButton()}),$(document).on("click",".removeField",function(){viaCount--,toggleAddButton(),$(this).closest(".field").remove(),$(".field").each(function(e){$(this).find(".viaFieldHd").html("Via "+e+" ")})});var accuserdb="";function addvalue(e){var t=$(e).text(),a=$(e).attr("luggagetype");if($("#number").val(""),$("#nameid").val(t),$("#nametype").val(a),accuserdb.includes(t)){var n=accuserdb.split(t)[0],i=n.substr(n.length-3).trim()[0];$("#number").val(i)}$("#moreModalitem").modal("hide"),$("#itemcount").modal("show")}function removeitem(e){var t=accuserdb.split(","),a=$(e).parent().parent().text().trim(),n=t.indexOf(a);t.splice(n,1),accuserdb=t.join(),$(e).parent().parent().remove()}function additem(e,t,a){var n=e.trim(),i=n.replace(/\s/g,"").replace(/[^\w]/g,"");if(accuserdb.includes(n)){var s=accuserdb.split(","),o=[];return s.forEach(function(e){if(e.includes(n)){var s=parseInt(t),l=`${s} ${n}`;o.push(l),$(`#${`id_${i}`}`).html(`\n                            <input class="form-control holddatainput" data-sendval="${s}@${n}" value="${l}" disabled data-type="${t} ${a}">\n                            <div class="input-group-addon">\n                                <button type="button" class="" onclick="removeitem(this)">\n                                    <img class="form-icons" src="https://book.barnettaxis.co.uk/images/close.png" alt="luggage delete" width="20">\n                                </button>\n                            </div>`)}else o.push(e)}),void(accuserdb=o.join(","))}insertitem(n,t,a)}function insertitem(e,t,a){var n=e.replace(/\s/g,"").replace(/[^\w]/g,""),i=`${t} ${e}`,s=`\n                <div class="col-lg-6 col-12">\n                <div class="field-hd">\n                              <span>Item Added</span>\n                            </div>\n                    <div id="id_${n}" class="dataHoldableWrap" data-type="${t} ${a}">\n                        <input class="form-control holddatainput" data-sendval="${t}@${e}" value="${i}" disabled data-type="${t} ${a}">\n                        <button type="button" class=" del-btn_" onclick="removeitem(this)">\n                            <img class="form-icons" src="https://book.barnettaxis.co.uk/images/close.png" alt="luggage delete" width="20">\n                        </button>\n                    </div>\n                </div>`;accuserdb.includes(i)||(accuserdb&&(accuserdb+=","),accuserdb+=i),$("#holdabledata").append(s)}function addHoursToDate(e,t){return new Date(new Date(e).setHours(e.getHours()+t))}$(".close-luggage").click(function(){$(".collapse").hasClass("in")&&($(".collapse").removeClass("in"),$(".luggage-btns").addClass("collapsed"))});const input=document.getElementById("passenger"),btnDec=document.getElementById("decrease"),btnInc=document.getElementById("increase");input.setAttribute("inputmode","numeric"),input.addEventListener("keypress",function(e){/[0-9]/.test(e.key)||e.preventDefault()});let max=200;function validatePassenger(){parseInt(input.value)>200?($("#passenger-error").text("Maximum allowed passengers is 200").show(),$("#passenger").addClass("field-error"),setTimeout(()=>{$("#passenger-error").hide(),$("#passenger").removeClass("field-error")},3e3)):($("#passenger-error").hide(),$("#Passenger").removeClass("field-error"))}btnInc.addEventListener("click",()=>{let e=parseInt(input.value);isNaN(e)?input.value=1:e<max&&(input.value=e+1),validatePassenger()}),btnDec.addEventListener("click",()=>{let e=parseInt(input.value);isNaN(e)||e<=1?input.value="":input.value=e-1,validatePassenger()}),input.addEventListener("input",()=>{let e=parseInt(input.value);validatePassenger(),!isNaN(e)&&e>max&&(input.value=max)});var inputsvalues,arrcheckincabin,Array_Luggage_text,listvias=[];function doScroll(e){setTimeout(()=>{if(window.innerWidth<=768){const t=e.getBoundingClientRect(),a=window.pageYOffset||document.documentElement.scrollTop;window.scrollTo({top:t.top+a-24,behavior:"smooth"})}},300)}$(document).ready(function(){$("#get-quotes").click(function(e){e.preventDefault();let t=!0;$(".fieldInput").each(function(){validateAddressField($(this))||(t=!1)});$("#book_pick_date").val();var a=$("#book_pick_time").val();addHoursToDate(new Date,1);inputsvalues=[],itemsValues=[],Array_Luggage_text=[],arrcheckincabin=[];for(var n=$(".holddatainput"),i=0;i<n.length;i++)itemsValues.push(n.data("sendval")),inputsvalues.push($(n[i]).data("sendval")),arrcheckincabin.push($(n[i]).data("type"));for(var s=0,o=0,l=0,r=0;r<arrcheckincabin.length;r++){var d=arrcheckincabin[r].split(" ");"cabin"==(d=d.filter(function(e){return null!=e&&""!=e}))[1]?s+=parseInt(d[0]):"checkin"==d[1]?o+=parseInt(d[0]):"passenger"==d[1]&&(l+=parseInt(d[0]))}var c=$("#pickup").val(),u=$("#dropof").val(),p=$("#book_pick_date").val(),m=a.split(":"),g=m[0],v=m[1],h=$("#passenger").val(),f=$("input[name='journeytype']:checked").val(),b=$("#minwaittime").val();$("#book_pick_from_doorno").val(),$("#book_pick_to_doorno").val();let E=$(".viadata").map((e,t)=>t.value.replace(/\|,/g,"@")).get();E=E.filter(function(e){return""!==e});let y=E.join("@");h=parseFloat(h)+parseInt(l);var w,_=!1,k=[];k.push(s),k.push(o),k.push(h),k.push(p),k.push(g),k.push(v),""==p||""==v||""==g?alert("ERROR!\nPlease select all things correctly."):Number.isNaN(h)||h<1||h>200?($("#passenger-error").text("Please select number of passengers (1–200)").show(),$("#Passenger").addClass("field-error")):t&&(w="luggage_text="+inputsvalues+"&pickup="+c+"&checkurl="+!0+"&dropoff="+u+"&office_details="+office_details+"&luggageobject="+k+"&listviasaddress="+`${y}&tripFlag=`+f+"&mints="+b+"&showVehicle="+_+"&colorCode="+color_code,$("#widgetBtnSpinner").show(),$("#getQuotesBtnTxt").hide(),$(".progressBarWrap").show(),$.ajax({url:`https://${destnationDomain}/Home/InsertPageUrl`,method:"POST",contentType:"application/json",data:JSON.stringify({Url:w}),success:function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){console.error("JSON parse error:",e)}if(console.log("API Response:",e),e.IsSuccess&&e.Data&&e.Data.Id){const t=`https://${destnationDomain}/OurVehicle/OurVehicleNew?id=${e.Data.Id}`,a=document.getElementById("progressBar");let n=0;a.style.width="0%",a.style.display="block",$(".progressBarWrap").show();const i=setInterval(()=>{n<90&&(n+=10*Math.random(),a.style.width=n+"%")},400);window.location.href=t,$(window).bind("pageshow",function(){clearInterval(i),a.style.width="100%",setTimeout(()=>{a.style.display="none",$(".progressBarWrap").hide(),$("#widgetBtnSpinner").hide(),$("#getQuotesBtnTxt").show()},500)})}else alert("Booking failed: "+(e.Message||"Unknown error")),$("#widgetBtnSpinner").hide(),$(".progressBarWrap").hide(),$("#getQuotesBtnTxt").show()},error:function(e,t,a){console.error("Error calling proxy:",a),alert("An error occurred while creating the booking."),$("#widgetBtnSpinner").hide(),$(".progressBarWrap").hide(),$("#getQuotesBtnTxt").show()},complete:function(){$("#widgetBtnSpinner").hide(),$("#getQuotesBtnTxt").show()}}))})}),$("button").click(function(){event.preventDefault()}),document.addEventListener("focusin",function(e){e.target.matches("#pickup, #dropof, .viadata, #minwaittime")&&doScroll(e.target)});const WaitnReturn=document.getElementById("waitReturn"),singleTrip=document.getElementById("single_trip"),inputWrap=document.getElementById("toggleWaitingTime");function toggleInput(){WaitnReturn.checked?(inputWrap.classList.add("show"),setTimeout(()=>{minwaittime.focus();const e=minwaittime.value;minwaittime.value="",minwaittime.value=e,doScroll(minwaittime)},300)):inputWrap.classList.remove("show")}WaitnReturn.addEventListener("change",toggleInput),singleTrip.addEventListener("change",toggleInput);const minwaittime=document.getElementById("minwaittime"),waittimeError=document.getElementById("waittimeError");let errorTimeout;function showError(e){clearTimeout(errorTimeout),waittimeError.textContent=e,waittimeError.style.display="block",minwaittime.classList.add("field-error"),errorTimeout=setTimeout(()=>{hideError()},3e3)}function hideError(){waittimeError.style.display="none",minwaittime.classList.remove("field-error")}minwaittime.setAttribute("inputmode","numeric"),minwaittime.addEventListener("keypress",function(e){/[0-9]/.test(e.key)||e.preventDefault()}),minwaittime.addEventListener("input",function(e){let t=e.target.value;if(t=t.replace(/^0+/,""),""===t||parseInt(t,10)<1)return e.target.value=1,void hideError();let a=parseInt(t,10);if(a>60)return e.target.value=60,void showError("Maximum value 60 allowed");e.target.value=a,hideError()}),document.querySelectorAll('input[type="date"], input[type="time"]').forEach(e=>{e.addEventListener("click",()=>{e&&"function"==typeof e.showPicker?e.showPicker():e.focus()})});const dateInput=document.getElementById("book_pick_date"),dateErrorBox=document.getElementById("dateError");dateInput.addEventListener("change",function(){let e=new Date;if(e.setHours(0,0,0,0),new Date(this.value)<e){let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");this.value=`${t}-${a}-${n}`,dateInput.classList.add("field-error"),dateErrorBox.style.display="block",setTimeout(()=>{dateInput.classList.remove("field-error"),dateErrorBox.style.display="none"},3e3)}});const sploader=document.getElementById("sploader");sploader.style.display="block";const APIURL="https://stationcarslondon.com/api/ItemsAPI/GetItems";async function getLinks(){try{var e=office_details.split(",")[0];let t=localStorage.getItem("appLinks");if(t)console.log("Using cached data"),t=JSON.parse(t),processButtons(t);else{let t=await fetch(`https://booking.londontaxi247.co.uk/home/GetLinks?officeCode=${e}`);if(!t.ok)throw new Error("Address Not Found "+t.status);let a=await t.json();a.IsSuccess&&a.Data&&(console.log("Caching new data"),localStorage.setItem("appLinks",JSON.stringify(a.Data)),processButtons(a.Data))}}catch(e){console.error("Error While fetching API:",e)}}function processButtons(e){const t=document.querySelectorAll(".androidBtn"),a=document.querySelectorAll(".iosBtn"),n=navigator.userAgent.toLowerCase(),i=/android/.test(n),s=/iphone|ipod|ipad/.test(n);i?(t.forEach(e=>e.style.display="block"),a.forEach(e=>e.style.display="none")):s?(a.forEach(e=>e.style.display="block"),t.forEach(e=>e.style.display="none")):(t.forEach(e=>e.style.display="block"),a.forEach(e=>e.style.display="block")),t.forEach(t=>{t.onclick=()=>window.open(e.AndroidLink,"_blank")}),a.forEach(t=>{t.onclick=()=>window.open(e.IosLink,"_blank")})}fetch(APIURL).then(e=>e.json()).then(e=>{const t=e.data,a=document.getElementById("accordionExample");t.forEach((e,t)=>{const n=document.createElement("div");n.className="card";const i=document.createElement("div");i.className="card-header",i.setAttribute("role","tab"),i.id=`heading${t}`;const s=document.createElement("button");s.className="btn collapsed luggage-btns",s.type="button",s.setAttribute("data-toggle","collapse"),s.setAttribute("data-target",`#collapse${t}`),s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",`collapse${t}`),s.textContent=e.ItemName||e.itemname||"Unnamed Item",i.appendChild(s);const o=document.createElement("div");o.id=`collapse${t}`,o.className="collapse",o.setAttribute("data-parent","#accordionExample"),o.setAttribute("aria-labelledby",`heading${t}`);const l=document.createElement("div");l.className="card-body",(e.LineItems||e.itemsubchild||[]).forEach((e,t)=>{const a=document.createElement("button");a.type="button",a.className="btn luggage-items-btn",a.setAttribute("data-idss",t),a.setAttribute("luggagetype",e.type||""),a.setAttribute("onclick","addvalue(this)"),a.textContent=e.name||e,l.appendChild(a)}),o.appendChild(l),n.appendChild(i),n.appendChild(o),a.appendChild(n)}),sploader.style.display="none"}).catch(e=>{console.error(e),sploader.style.display="none"}),getLinks();